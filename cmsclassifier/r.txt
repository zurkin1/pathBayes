# --- 1. Install Dependencies ---
# Ensure BiocManager is up-to-date
install.packages("BiocManager")
# Update all existing packages (important after R update)
BiocManager::install(update = TRUE, ask = FALSE)
# Install the specific packages needed
BiocManager::install(c("AnnotationDbi", "org.Hs.eg.db"))
# Install standard CRAN packages
install.packages(c("mclust", "survival"))
# --- 2. Install CMSClassifier from your local file ---
# IMPORTANT: Replace "path/to/CMSclassifier_1.0.0.tar.gz" with the actual path on your computer
install.packages("c:/temp/CMSclassifier_1.0.0.tar.gz", repos = NULL, type = "source")
# --- 3. Load Libraries ---
library(CMSclassifier)
library(org.Hs.eg.db)
library(AnnotationDbi)

# --- 4. Load Expression Data ---
# Use the *full* (not shortened) merged expression file
exp_data <- read.delim("c:/temp/TCGACRC_expression-merged.tsv", stringsAsFactors = FALSE)

# --- 5. IMPORTANT: Convert Gene Symbols to Entrez IDs ---
# Get the gene symbols from the 'feature' column
gene_symbols <- exp_data$feature
# Map symbols to Entrez IDs.
# We take the 'first' valid ID if a symbol maps to multiple.
entrez_ids <- mapIds(org.Hs.eg.db,
                     keys = gene_symbols,
                     column = "ENTREZID",
                     keytype = "SYMBOL",
                     multiVals = "first")

# --- 6. Prepare the Matrix for the Classifier ---
# Add Entrez IDs as a new column
exp_data$entrez <- entrez_ids
# Remove genes that did not map to an Entrez ID
exp_data <- exp_data[!is.na(exp_data$entrez), ]
# Remove duplicate Entrez IDs (a requirement for the classifier)
exp_data <- exp_data[!duplicated(exp_data$entrez), ]
# Set the rownames to be the Entrez IDs
rownames(exp_data) <- exp_data$entrez
# Remove the non-numeric 'feature' and 'entrez' columns
exp_data$feature <- NULL
exp_data$entrez <- NULL
# Convert to a numeric matrix (required by the function)
exp_matrix <- as.matrix(exp_data)
# (Optional but Recommended) Filter out samples from the strict outlier list
outliers <- read.delim("c:/temp/TCGACRC_expression_merged_outlier_strict.txt", header = FALSE)
# Ensure sample names are formatted identically (e.g., replace dots with dashes if needed)
outlier_samples <- as.character(outliers$V1)
clean_matrix <- exp_matrix[, !colnames(exp_matrix) %in% outlier_samples]
print(paste("Original matrix had", ncol(exp_matrix), "samples."))
print(paste("Clean matrix has", ncol(clean_matrix), "samples."))

# --- 6.5: Filter Your Matrix for the RF Classifier ---
# Load the internal gene templates for the Random Forest model
# This object is included with the CMSclassifier package
data(model)
# Get the list of required Entrez IDs from the template
required_genes <- rownames(model$RF$importance)
# Create a new matrix that *only* contains genes found in the RF template
matrix_for_cms <- clean_matrix[rownames(clean_matrix) %in% required_genes, ]
# (Optional) Check how many genes matched
print(paste("Original matrix had", nrow(clean_matrix), "genes."))
print(paste("RF template requires", length(required_genes), "genes."))
print(paste("Your new matrix has", nrow(matrix_for_cms), "matching genes."))

# --- 7. Run the Classifier ---
# We use the clean matrix
# method = "RF" (Random Forest) is the default and recommended method.
cms_results <- classifyCMS(clean_matrix, method = "RF")
# View the results
# This shows the CMS label (CMS1-4, or "NOLBL" for no label)
print(head(cms_results$CMS))

# --- 8. Load Clinical Data ---
clinical_data <- read.delim("TCGACRC_clinical-merged.tsv")
# --- 9. Combine Classification with Clinical Data ---
# Create a clean data frame from the classifier results
results_df <- data.frame(sample_id = names(cms_results$CMS), 
                         cms_label = cms_results$CMS)
# Merge with clinical data
# The clinical file uses 'id' for the sample identifier
merged_analysis_data <- merge(results_df, 
                              clinical_data, 
                              by.x = "sample_id", 
                              by.y = "id")
# --- 10. Create Contingency Table and Test for Association ---
# See how many samples of each CMS type fall into each clinical stage
contingency_table <- table(merged_analysis_data$cms_label, 
                           merged_analysis_data$stage)
print("--- CMS Subtype vs. Clinical Stage ---")
print(contingency_table)
# Run a Chi-squared test to see if the association is statistically significant
print("--- Chi-squared Test for Association ---")
print(chisq.test(contingency_table))